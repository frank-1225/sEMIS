<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åˆ—è½¦è¿è¡Œä¿¡æ¯ç»¼åˆæŸ¥è¯¢ç³»ç»Ÿ</title>
    <style>
        /* --- åŸºç¡€æ ·å¼ --- */
        body { 
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; 
            padding: 20px; 
            background-color: #f4f7f6;
        }
        h1 {
            color: #1a73e8;
            border-bottom: 2px solid #e0e0e0;
            padding-bottom: 10px;
        }
        h2 {
            margin-top: 30px;
            color: #333;
        }
        
        /* --- ç™»å½•æ¨¡æ€æ¡†æ ·å¼ --- */
        #loginModal {
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .login-content {
            background-color: #fff;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
            width: 300px;
            text-align: center;
        }
        .login-content input {
            width: 90%;
            padding: 10px;
            margin: 15px 0;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .login-btn {
            width: 100%;
            padding: 10px;
            background-color: #1a73e8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
        }
        .login-btn:hover { background-color: #1558b3; }
        .login-error { color: red; margin-top: 10px; font-size: 0.9em; display: none; }

        /* --- æŸ¥è¯¢æ§åˆ¶åŒºæ ·å¼ --- */
        #queryControl {
            background-color: #ffffff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            display: flex; 
            align-items: center;
            gap: 15px;
            flex-wrap: wrap; 
        }
        #trainInput { 
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            width: 150px;
        }
        button.query-btn {
            padding: 10px 15px;
            background-color: #1a73e8;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button.query-btn:hover { background-color: #1558b3; }
        button:disabled { background-color: #ccc; cursor: not-allowed; }

        /* --- çŠ¶æ€ä¿¡æ¯æ ·å¼ --- */
        #statusMessage {
            margin-top: 10px;
            padding: 8px;
            border-radius: 4px;
        }
        .success { color: green; }
        .error { color: white; background-color: #dc3545; }
        
        /* --- Schedule/Calendar Styles --- */
        #scheduleContainer { margin-top: 30px; margin-bottom: 20px; }
        .calendar-box {
            background-color: #ffffff;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        .calendar-header {
            text-align: center;
            font-size: 1.2em;
            font-weight: bold;
            margin-bottom: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .calendar-header strong { margin: 0 15px; }
        .nav-btn {
            padding: 5px 10px;
            background-color: #f0f0f0;
            color: #333;
            border: 1px solid #ccc;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
        }
        .calendar-table { width: 100%; border-collapse: collapse; }
        .calendar-table th { font-weight: normal; padding: 10px 5px; color: #666; border-bottom: 1px solid #eee; }
        .calendar-day {
            padding: 8px;
            text-align: center;
            font-size: 0.9em;
            border: 1px solid #eee;
            height: 40px;
            vertical-align: middle;
        }
        .calendar-day.empty { background-color: #f9f9f9; cursor: default; }
        .calendar-day.pending { background-color: #e3f2fd; cursor: wait; }
        .calendar-day.not-running { background-color: #e0e0e0; color: #999; cursor: default; }
        .calendar-day.running {
            background-color: #ffffff;
            cursor: pointer;
            font-weight: bold;
            color: #1a73e8;
            transition: background-color 0.2s;
        }
        .calendar-day.running:hover { background-color: #f0f4f7; }
        .calendar-day.today { border: 2px solid #ff6347; border-radius: 4px; }

        /* --- è¯¦ç»†ä¿¡æ¯å®¹å™¨ --- */
        .consist-detail-box {
            margin-top: 30px; 
            padding: 15px; 
            border: 1px solid #ccc; 
            background-color: #ffffff;
            border-radius: 6px;
            overflow-x: auto; 
        }
        .consist-info { margin-top: 5px; margin-bottom: 15px; font-size: 1em; color: #555; }

        /* --- åŸºæœ¬ä¿¡æ¯æ ·å¼ --- */
        .basic-info-box {
            border-left: 5px solid #1a73e8;
            margin-bottom: 15px !important;
            margin-top: 10px !important;
            padding: 15px; 
            background-color: #ffffff; 
            border-radius: 6px; 
        }
        .error-box { border-left: 5px solid #dc3545 !important; background-color: #fbecec !important; }
        
        .basic-info-station-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.85em; }
        .basic-info-station-table th, .basic-info-station-table td { border: 1px solid #e0e0e0; padding: 6px; text-align: center; }
        .basic-info-station-table th { background-color: #f0f4f7; color: #333; }
        .basic-info-station-table td:nth-child(7) { white-space: normal; }

        /* --- è½¦å‹ä¿¡æ¯è¡¨æ ¼ --- */
        .trainset-info-table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 0.9em; }
        .trainset-info-table td { border: 1px solid #e0e0e0; padding: 8px; width: 25%; text-align: left; }
        .trainset-info-table td:nth-child(odd) { background-color: #f0f4f7; font-weight: bold; color: #333; }

        /* --- ç¼–ç»„è¡¨æ ¼æ ·å¼ --- */
        .consist-table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        .consist-table th, .consist-table td { border: 1px solid #bbb; padding: 8px; text-align: center; font-size: 0.9em; white-space: nowrap; }
        .consist-table th { background-color: #3498db; color: white; font-weight: bold; }
        .consist-table tbody tr:nth-child(odd) { background-color: #ecf0f1; }
        .car-type-c { background-color: #fff8e1; font-weight: bold; color: #f39c12; }

        /* --- é‡è”/æ ·å¼ --- */
        .coupled-box { border-color: #f39c12 !important; background-color: #fef9e7 !important; padding-bottom: 0 !important; }
        .coupled-title { color: #f39c12; font-weight: bold; border-bottom: 2px dashed #f39c12; padding-bottom: 8px; margin-bottom: 15px; }
        .single-consist { border: 1px solid #ddd; margin-bottom: 15px; padding: 10px; border-radius: 4px; background-color: #ffffff; }
        
        .emu-no-clickable { cursor: pointer; color: #1a73e8; text-decoration: underline; transition: color 0.2s; }
        .emu-no-clickable:hover { color: #1558b3; }

        /* --- å†å²è¡¨æ ¼æ ·å¼ --- */
        .history-table { width: 90%; margin: 15px auto 5px auto; border-collapse: collapse; font-size: 0.85em; }
        .history-table th, .history-table td { border: 1px solid #e0e0e0; padding: 6px; text-align: center; }
        .history-table th { background-color: #f0f4f7; color: #333; }
        .close-history-btn { float: right; cursor: pointer; font-weight: bold; color: #dc3545; padding: 0 5px; border: 1px solid #dc3545; border-radius: 3px; }
        .history-table td:last-child { white-space: normal; text-align: left; }
        .history-train-link { cursor: pointer; color: #28a745; text-decoration: underline; margin: 0 5px; }
        .history-train-link:hover { color: #1e7e34; }
        .missing-link { color: #f39c12; font-weight: bold; font-size: 0.9em; margin: 0 5px; }
    /* --- æ–°å¢ï¼šå‚æ•°ä¿¡æ¯ç½‘æ ¼æ ·å¼ --- */
        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 8px;
            margin-bottom: 15px;
            font-size: 0.9em;
            background-color: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            border: 1px solid #eee;
        }
        .info-item {
            display: flex;
            justify-content: space-between;
            padding: 4px 8px;
            background: white;
            border-radius: 3px;
            border: 1px solid #e0e0e0;
        }
        .info-label {
            color: #666;
            font-weight: normal;
            margin-right: 8px;
        }
        .info-value {
            color: #333;
            font-weight: bold;
            text-align: right;
        }

        /* ä¸“é—¨ç”¨äºä¸‹æ–¹å®šå‘˜ä¿¡æ¯çš„æ ·å¼å¾®è°ƒ */
        .capacity-grid {
            margin-top: 15px;
            background-color: #f0f7ff; /* æµ…è“è‰²èƒŒæ™¯åŒºåˆ† */
            border-color: #d0e3f5;
        }
        .capacity-grid .info-item {
            border-color: #cce5ff;
        }
    </style>
</head>
<body>
    <a id="top"></a>
    
    <div id="loginModal">
        <div class="login-content">
            <h3>ğŸ”’ ç³»ç»Ÿç™»å½•</h3>
            <p>è¯·è¾“å…¥å¯†ç ä»¥è®¿é—®ç¼–ç»„æ•°æ®åº“</p>
            <input type="password" id="apiPassword" placeholder="è¾“å…¥å¯†ç " onkeydown="if(event.keyCode==13) performLogin()">
            <button class="login-btn" onclick="performLogin()">ç™»å½•</button>
            <p id="loginError" class="login-error">å¯†ç é”™è¯¯æˆ–è¿æ¥å¤±è´¥</p>
        </div>
    </div>

    <h1>ğŸš… åˆ—è½¦è¿è¡Œä¿¡æ¯ç»¼åˆæŸ¥è¯¢ç³»ç»Ÿ</h1>

    <div id="queryControl">
        <label for="trainInput">è¾“å…¥è½¦æ¬¡ï¼š</label>
        <input type="text" id="trainInput"  value="G1" required>
        <button id="mainQueryBtn" class="query-btn" onclick="queryTrainData(document.getElementById('trainInput').value.trim().toUpperCase(), TODAY_DATE_STR, true)">æŸ¥è¯¢</button>
    </div>

    <p id="statusMessage" class="success">è¯·å…ˆç™»å½•ç³»ç»Ÿ...</p>
    
    <div id="scheduleContainer">
        <h2>ğŸ—“ï¸ å¼€è¡Œè§„å¾‹</h2>
        <div class="calendar-box">
            <div id="monthTitle" class="calendar-header">
                è¯·å…ˆè¾“å…¥è½¦æ¬¡å¹¶ç‚¹å‡»æŸ¥è¯¢ã€‚
            </div>
            <div id="scheduleStatus" style="text-align: center; margin: 10px 0; font-size: 0.9em; color: #666;">
                ç­‰å¾…æŸ¥è¯¢...
            </div>
            <table class="calendar-table">
                <thead>
                    <tr>
                        <th>ä¸€</th><th>äºŒ</th><th>ä¸‰</th><th>å››</th><th>äº”</th><th>å…­</th><th>æ—¥</th>
                    </tr>
                </thead>
                <tbody id="calendarBody"></tbody>
            </table>
        </div>
    </div>
    <div id="consistDetailsContainer">
        <h2>ğŸ“„ è¯¦ç»†ä¿¡æ¯</h2>
        <div class="consist-detail-box">è¾“å…¥è½¦æ¬¡ã€ç‚¹å‡»æŸ¥è¯¢ä»¥æŸ¥çœ‹è¯¦ç»†ç¼–ç»„å†å²å’ŒåŸºæœ¬ä¿¡æ¯ã€‚</div>
    </div>

    <script>
        // === API é…ç½® ===
        const API_BASE_URL_TRAIN = "https://frank1225.dynv6.net:16667/"; 
        const API_BASE_URL_HISTORY = "https://frank1225.dynv6.net:16668/"; 
        const API_PROXY_URL_BASIC_INFO = 'https://frank1225.dynv6.net:16669/api'; 
        
        // ç¼–ç»„æ•°æ®åº“ API
        const CONSIST_API_BASE = "https://frank1225.dynv6.net:5125";
        const CONSIST_API_LOGIN = `${CONSIST_API_BASE}/api/login`;
        const CONSIST_API_QUERY = `${CONSIST_API_BASE}/api/data`;

        // å…¨å±€å˜é‡
        let API_AUTH_TOKEN = null;  // å­˜å‚¨ç™»å½• Token
        let CONSIST_DATA_MAP = new Map(); // ç¼“å­˜æœ¬æ¬¡ä¼šè¯æŸ¥åˆ°çš„ç¼–ç»„æ•°æ®
        
        let TODAY_DATE_STR = '';         
        let currentCalendarDate = new Date(); 
        let cachedConsistHistoryData = []; 
        let lastQueriedTrainNo = '';       
        let basicInfoCache = new Map(); 

        // å±€åæ˜ å°„è¡¨
        const BUREAU_MAP = {
            'P': 'åŒ—äº¬å±€', 'H': 'ä¸Šæµ·å±€', 'Q': 'å¹¿å·å±€', 'Z': 'å—å®å±€', 'G': 'å—æ˜Œå±€',
            'W': 'æˆéƒ½å±€', 'M': 'æ˜†æ˜å±€', 'N': 'æ­¦æ±‰å±€', 'F': 'éƒ‘å·å±€', 'K': 'æµå—å±€',
            'T': 'æ²ˆé˜³å±€', 'B': 'å“ˆå°”æ»¨å±€', 'C': 'å‘¼å’Œå±€', 'V': 'å¤ªåŸå±€', 'Y': 'è¥¿å®‰å±€',
            'J': 'å…°å·å±€', 'R': 'ä¹Œé²æœ¨é½å±€', 'O': 'é’è—é›†å›¢'
        };

        const CHINA_LAOS_STATIONS = [
            'ç£¨ä¸', 'çº³å †', 'çº³ç£¨', 'å­Ÿèµ›', 'å­Ÿé˜¿', 
            'ç…å‹ƒæ‹‰é‚¦', 'å˜è¥¿', 'ä¸‡è£', 'è“¬æ´ª', 'ä¸‡è±¡'
        ];

        // ----------------------------------------------------
        // 1. ç™»å½•é€»è¾‘
        // ----------------------------------------------------
        
        async function performLogin() {
            const password = document.getElementById('apiPassword').value;
            const errorMsg = document.getElementById('loginError');
            
            if (!password) return;

            try {
                const response = await fetch(CONSIST_API_LOGIN, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password: password })
                });

                if (response.ok) {
                    const data = await response.json();
                    if (data.auth_key) {
                        API_AUTH_TOKEN = data.auth_key;
                        document.getElementById('loginModal').style.display = 'none';
                        document.getElementById('statusMessage').textContent = 'âœ… ç™»å½•æˆåŠŸï¼Œç³»ç»Ÿå°±ç»ªã€‚';
                        document.getElementById('statusMessage').className = 'success';
                    } else {
                        throw new Error('No auth key received');
                    }
                } else {
                    errorMsg.style.display = 'block';
                    errorMsg.textContent = 'å¯†ç é”™è¯¯ï¼Œè¯·é‡è¯•ã€‚';
                }
            } catch (e) {
                console.error(e);
                errorMsg.style.display = 'block';
                errorMsg.textContent = 'è¿æ¥æœåŠ¡å™¨å¤±è´¥ã€‚';
            }
        }

        // ----------------------------------------------------
        // 2. ç¼–ç»„æ•°æ®è·å– (æ–° API å®ç°)
        // ----------------------------------------------------

        /**
         * ä» API è·å–å•ä¸ªåŠ¨è½¦ç»„çš„è¯¦ç»†ä¿¡æ¯
         * åç«¯ä¼šè‡ªåŠ¨åŒ¹é…â€œæŸ¥è¯¢ç”¨è½¦ç»„å·â€å­—æ®µ
         */
        async function fetchConsistByEmuNo(emuNo) {
            if (CONSIST_DATA_MAP.has(emuNo)) return; // å·²ç¼“å­˜

            // Python åç«¯ä¼šå¤„ç† train_search çš„æ ¼å¼ï¼ˆå»æ¨ªæ ï¼‰ï¼Œè¿™é‡Œç›´æ¥ä¼  emu_no
            const payload = {
                "draw": 1,
                "start": 0,
                "length": 1, // åªéœ€è¦ä¸€æ¡æœ€åŒ¹é…çš„è®°å½•
                "custom_filters": {
                    "train": emuNo 
                }
            };

            try {
                const response = await fetch(CONSIST_API_QUERY, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Auth-Key': API_AUTH_TOKEN
                    },
                    body: JSON.stringify(payload)
                });

                if (response.ok) {
                    const json = await response.json();
                    if (json.data && json.data.length > 0) {
                        // å­˜å…¥ Mapï¼Œkey ä¸ºåŸå§‹ emuNo
                        CONSIST_DATA_MAP.set(emuNo, {
                            record: json.data[0],
                            raw_key: emuNo
                        });
                    }
                } else {
                    console.warn(`Fetch consist failed for ${emuNo}: ${response.status}`);
                }
            } catch (e) {
                console.error(`Network error fetching consist for ${emuNo}`, e);
            }
        }

        /**
         * æ‰¹é‡è·å–å†å²è®°å½•ä¸­å‡ºç°çš„æ‰€æœ‰åŠ¨è½¦ç»„çš„ç¼–ç»„ä¿¡æ¯
         */
        async function prefetchConsistsForHistory(historyData) {
            if (!historyData || historyData.length === 0) return;

            const uniqueEmus = new Set();
            historyData.forEach(item => {
                if (item.emu_no) uniqueEmus.add(item.emu_no);
            });

            const promises = Array.from(uniqueEmus).map(emu => fetchConsistByEmuNo(emu));
            
            // å¹¶è¡Œè¯·æ±‚
            const statusElement = document.getElementById('statusMessage');
            statusElement.textContent += ` (æ­£åœ¨è·å– ${uniqueEmus.size} ç»„ç¼–ç»„è¯¦æƒ…...)`;
            
            await Promise.all(promises);
        }

        // ----------------------------------------------------
        // 3. è¾…åŠ©å‡½æ•°
        // ----------------------------------------------------

        function shouldSkipEmuHistory(trainNo) {
            if (!trainNo || trainNo.length === 0) return true;
            const upperTrainNo = trainNo.toUpperCase();
            const firstChar = upperTrainNo.charAt(0);
            if (firstChar === 'S') return true;
            if (['Z', 'T', 'K', 'L', 'Y'].includes(firstChar)) return true;
            if (upperTrainNo.length === 4 && /^\d{4}$/.test(upperTrainNo)) return true;
            return false;
        }

        function cleanEmuKey(rawKey) {
            // å‰ç«¯ä¸»è¦è´Ÿè´£å±•ç¤ºå’Œç¼“å­˜é”®ï¼ŒAPIè¯·æ±‚ç›´æ¥ç”¨ rawKey äº¤ç»™åç«¯æ¨¡ç³ŠåŒ¹é…
            return rawKey; 
        }

        function formatDateToYYYYMMDD(date) {
            const yyyy = date.getFullYear();
            const mm = String(date.getMonth() + 1).padStart(2, '0');
            const dd = String(date.getDate()).padStart(2, '0');
            return `${yyyy}-${mm}-${dd}`;
        }
        
        function formatTime(timeStr) { 
            if (!timeStr || timeStr === '--' || timeStr.length < 3) return timeStr;
            let timePartMatch = timeStr.match(/(\d{4})$/); 
            let cleaned = timePartMatch ? timePartMatch[1] : timeStr.replace(/[^0-9]/g, '');
            if (cleaned.length === 4) {
                return `${parseInt(cleaned.substring(0, 2), 10)}:${cleaned.substring(2, 4)}`;
            }
            return timeStr; 
        }

        function formatDayDifference(dayDiff) { 
            const diff = parseInt(dayDiff, 10);
            if (isNaN(diff)) return '---';
            if (diff === 0) return 'å½“å¤©';
            return `ç¬¬${diff + 1}å¤©`;
        }

        function formatStationCorporationCode(stationName, code) { 
            if (stationName === 'é¦™æ¸¯è¥¿ä¹é¾™') return 'æ¸¯é“å…¬å¸';
            if (CHINA_LAOS_STATIONS.includes(stationName)) return 'ä¸­è€é“è·¯å…¬å¸';
            if (!code || typeof code !== 'string' || code === '---') return '---';
            const parts = code.split('#');
            if (parts.length !== 2) return code; 
            const bureauCode = parts[0].toUpperCase();
            let stationSectionName = parts[1].trim();
            const fullBureauName = BUREAU_MAP[bureauCode] || `${bureauCode}å±€`;
            if (stationSectionName && !stationSectionName.endsWith('æ®µ')) {
                stationSectionName += 'ç›´å±ç«™';
            } else if (!stationSectionName) {
                stationSectionName = 'æœªçŸ¥ç«™æ®µ';
            }
            return `${fullBureauName}${stationSectionName}`;
        }

        // ----------------------------------------------------
        // 4. æ—¥å†é€»è¾‘
        // ----------------------------------------------------
        
        function getDaysInMonth(year, month) {
            return new Date(year, month + 1, 0).getDate();
        }
        
        async function checkTrainRun(trainCode, dateStr) {
            const result = await fetchBasicTrainInfo(trainCode, dateStr); 
            return result.success && result.info && result.info.stations.length > 0;
        }

        async function checkScheduleForMonth(year, month, trainNo) {
            const daysInMonth = getDaysInMonth(year, month);
            const dateChecks = [];
            const scheduleStatus = document.getElementById('scheduleStatus');
            
            if (!trainNo) {
                scheduleStatus.textContent = `è¯·è¾“å…¥è½¦æ¬¡è¿›è¡Œå¼€è¡Œè§„å¾‹æŸ¥è¯¢ã€‚`;
                return;
            }
            
            scheduleStatus.textContent = `æ­£åœ¨æŸ¥è¯¢ ${year}å¹´${month + 1}æœˆ ${trainNo} çš„å¼€è¡Œè§„å¾‹...`;
            
            for (let day = 1; day <= daysInMonth; day++) {
                const date = new Date(year, month, day);
                const dateStr = formatDateToYYYYMMDD(date);
                const checkPromise = checkTrainRun(trainNo, dateStr).then(isRunning => {
                    return { day: day, isRunning: isRunning, dateStr: dateStr };
                });
                dateChecks.push(checkPromise);
            }
            
            const results = await Promise.all(dateChecks);

            results.forEach(result => {
                const dayCell = document.getElementById(`day-${result.dateStr}`);
                if (dayCell) {
                    dayCell.className = `calendar-day ${result.isRunning ? 'running' : 'not-running'} ${dayCell.classList.contains('today') ? 'today' : ''}`;
                    if (result.isRunning) {
                        dayCell.onclick = () => { queryTrainData(trainNo, result.dateStr, false); };
                    } else {
                        dayCell.onclick = null; 
                    }
                }
            });
            scheduleStatus.textContent = `âœ… ${year}å¹´${month + 1}æœˆ ${trainNo} å¼€è¡Œè§„å¾‹æŸ¥è¯¢å®Œæˆã€‚`;
        }

        function renderCalendar(trainNo) {
            const calendarContainer = document.getElementById('calendarBody');
            const monthTitle = document.getElementById('monthTitle');
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            
            if (!calendarContainer || !monthTitle || !trainNo) return;
            
            monthTitle.innerHTML = `<button class="nav-btn" onclick="navigateCalendar(-1, '${trainNo}')">â—€</button>
                                    <strong>${year}å¹´${month + 1}æœˆ</strong>
                                    <button class="nav-btn" onclick="navigateCalendar(1, '${trainNo}')">â–¶</button>`;
            
            calendarContainer.innerHTML = ''; 
            const firstDayOfMonth = new Date(year, month, 1).getDay(); 
            const startOffset = (firstDayOfMonth === 0) ? 6 : firstDayOfMonth - 1; 
            const daysInMonth = getDaysInMonth(year, month);
            const todayStr = TODAY_DATE_STR; 

            let dayCounter = 1;
            for (let i = 0; i < 6; i++) { 
                const row = document.createElement('tr');
                let rowContent = '';
                let hasRealDay = false;
                for (let j = 0; j < 7; j++) { 
                    const currentCellIndex = i * 7 + j;
                    if (currentCellIndex < startOffset || dayCounter > daysInMonth) {
                        rowContent += '<td class="calendar-day empty"></td>';
                    } else {
                        const date = new Date(year, month, dayCounter);
                        const dateStr = formatDateToYYYYMMDD(date);
                        const isToday = todayStr === dateStr;
                        rowContent += `<td class="calendar-day pending ${isToday ? 'today' : ''}" id="day-${dateStr}" title="ç‚¹å‡»æŸ¥è¯¢ ${trainNo} ${dateStr} è¯¦æƒ…">${dayCounter}</td>`;
                        dayCounter++;
                        hasRealDay = true;
                    }
                }
                row.innerHTML = rowContent;
                if (hasRealDay) calendarContainer.appendChild(row);
                if (dayCounter > daysInMonth) break; 
            }
            checkScheduleForMonth(year, month, trainNo);
        }

        function navigateCalendar(offset, trainNo) {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            currentCalendarDate = new Date(year, month + offset, 1); 
            renderCalendar(trainNo);
        }

        function resetCalendar(trainNo) {
            const today = new Date();
            currentCalendarDate = new Date(today.getFullYear(), today.getMonth(), 1);
            renderCalendar(trainNo);
        }
        
        // ----------------------------------------------------
        // 5. æ•°æ®æŸ¥è¯¢é€»è¾‘ (åŸºæœ¬ä¿¡æ¯ & è‡ªåŠ¨æœç´¢)
        // ----------------------------------------------------

        async function fetchBasicTrainInfo(trainCode, rawStartDay) { 
            const upperTrainCode = trainCode.toUpperCase();
            const cacheKey = `${upperTrainCode}_${rawStartDay}`;
            if (basicInfoCache.has(cacheKey)) return basicInfoCache.get(cacheKey);
            
            const startDay = rawStartDay.replace(/-/g, ''); 
            const requestData = { trainCode: upperTrainCode, startDay: startDay };
            
            try {
                const response = await fetch(API_PROXY_URL_BASIC_INFO, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, 
                    body: new URLSearchParams(requestData) 
                });

                if (!response.ok) {
                    const result = { success: false, message: `åŸºæœ¬ä¿¡æ¯ä»£ç†è¯·æ±‚å¤±è´¥ ${response.status}ã€‚` };
                    basicInfoCache.set(cacheKey, result);
                    return result;
                }

                const data = await response.json();
                if (data.status === true && data.data && data.data.trainDetail) {
                    const stopTimes = data.data.trainDetail.stopTime || [];
                    if (stopTimes.length === 0) {
                        const result = { success: false, message: "åŸºæœ¬ä¿¡æ¯ APIï¼šæ— åœç«™ä¿¡æ¯ã€‚" };
                        basicInfoCache.set(cacheKey, result);
                        return result;
                    }
                    
                    const startStationInfo = stopTimes[0];
                    const endStationInfo = stopTimes[stopTimes.length - 1];
                    const basicInfo = {
                        train_no: trainCode,
                        start_station_name: startStationInfo.start_station_name,
                        startTime: startStationInfo.startTime, 
                        end_station_name: endStationInfo.stationName, 
                        arriveTime: endStationInfo.arriveTime, 
                        jiaolu_corporation_code: startStationInfo.jiaolu_corporation_code, 
                        jiaolu_dept_train: startStationInfo.jiaolu_dept_train, 
                        emu_style_no_primary: startStationInfo.train_style, 
                        emu_style_no_fallback: startStationInfo.jiaolu_train_style, 
                        trainsetTypeInfo: data.data.trainDetail.trainsetTypeInfo || null,
                        stations: stopTimes.map(s => ({
                            station_no: s.stationNo,
                            station_name: s.stationName,
                            arrive_time: s.arriveTime, 
                            start_time: s.startTime, 
                            stop_time: s.stopover_time,
                            dayDifference: s.dayDifference !== undefined ? s.dayDifference : 0, 
                            station_corporation_code: s.stationCorporationCode || s.station_corporation_code || '---', 
                            waitingRoom: s.waitingRoom || '---', 
                            wicket: s.wicket || '---',           
                            exit: s.exit || '---',              
                        }))
                    };
                    const result = { success: true, info: basicInfo };
                    basicInfoCache.set(cacheKey, result);
                    return result;
                }
                const result = { success: false, message: data.errorMsg || "åŸºæœ¬ä¿¡æ¯ API è¿”å›å¼‚å¸¸ã€‚" };
                basicInfoCache.set(cacheKey, result);
                return result;
            } catch (error) {
                const result = { success: false, message: `ç½‘ç»œé”™è¯¯: ${error.message}` };
                basicInfoCache.set(cacheKey, result);
                return result;
            }
        }

        async function fetchTrainEndpoints(trainCode, fullTimestamp) {
            const rawStartDay = fullTimestamp.substring(0, 10);
            const upperTrainCode = trainCode.toUpperCase();
            const cacheKey = `${upperTrainCode}_${rawStartDay}`;
            const cachedResult = basicInfoCache.get(cacheKey);

            if (cachedResult && cachedResult.success) {
                return {
                    start: cachedResult.info.start_station_name || 'æœªçŸ¥ç«™',
                    end: cachedResult.info.end_station_name || 'æœªçŸ¥ç«™'
                };
            }
            // Fallback request
            const startDay = rawStartDay.replace(/-/g, ''); 
            try {
                const response = await fetch(API_PROXY_URL_BASIC_INFO, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' }, 
                    body: new URLSearchParams({ trainCode: upperTrainCode, startDay: startDay }) 
                });
                if (!response.ok) throw new Error();
                const data = await response.json();
                if (data.status === true && data.data && data.data.trainDetail) {
                    const stopTimes = data.data.trainDetail.stopTime || [];
                    if (stopTimes.length < 1) return { start: 'æœªçŸ¥ç«™', end: 'æœªçŸ¥ç«™' };
                    return {
                        start: stopTimes[0].start_station_name || 'æœªçŸ¥ç«™',
                        end: stopTimes[stopTimes.length - 1].stationName || 'æœªçŸ¥ç«™'
                    };
                }
                return { start: 'æœªçŸ¥ç«™', end: 'æœªçŸ¥ç«™' };
            } catch (error) {
                return { start: 'æŸ¥è¯¢å¤±è´¥', end: 'æŸ¥è¯¢å¤±è´¥' };
            }
        }

        async function searchForRunningDate(trainCode, rawStartDate) {
            const start = new Date(rawStartDate);
            // åæœ 30 å¤©
            for (let i = 1; i <= 30; i++) {
                const searchDate = new Date(start);
                searchDate.setDate(start.getDate() + i);
                const dateStr = formatDateToYYYYMMDD(searchDate);
                const isRunning = await checkTrainRun(trainCode, dateStr);
                if (isRunning) return { date: dateStr, direction: 'forward', days: i };
            }
            // å‰æœ 180 å¤©
            for (let i = 1; i <= 180; i++) {
                const searchDate = new Date(start);
                searchDate.setDate(start.getDate() - i);
                const dateStr = formatDateToYYYYMMDD(searchDate);
                if (searchDate.getFullYear() < 2000) break;
                const isRunning = await checkTrainRun(trainCode, dateStr);
                if (isRunning) return { date: dateStr, direction: 'backward', days: i };
            }
            return null; 
        }

        // ----------------------------------------------------
        // 6. ä¸»æŸ¥è¯¢æ§åˆ¶å™¨
        // ----------------------------------------------------

        async function queryTrainData(manualTrainNo, manualStartDate, isFullQuery = true) {
            // éªŒè¯ç™»å½•çŠ¶æ€
            if (!API_AUTH_TOKEN) {
                document.getElementById('loginModal').style.display = 'flex';
                return;
            }

            const trainInput = document.getElementById('trainInput');
            const trainNo = (manualTrainNo || trainInput.value).trim().toUpperCase(); 
            const startDate = manualStartDate || TODAY_DATE_STR; 

            if (trainNo) trainInput.value = trainNo; 

            const statusElement = document.getElementById('statusMessage');
            const consistDetailsContainer = document.getElementById('consistDetailsContainer');

            if (!trainNo || trainNo.length > 6 || trainNo.length < 2) {
                statusElement.textContent = 'é”™è¯¯ï¼šè½¦æ¬¡æ ¼å¼é”™è¯¯ã€‚';
                statusElement.className = 'error';
                return;
            }
            
            if (trainNo !== lastQueriedTrainNo) isFullQuery = true;
            
            consistDetailsContainer.innerHTML = '<h2>ğŸ“„ è¯¦ç»†ä¿¡æ¯</h2><div class="consist-detail-box">æ­£åœ¨è¯·æ±‚æ•°æ®... è¯·ç¨å€™ã€‚</div>';
            
            const skipHistory = shouldSkipEmuHistory(trainNo); 
            let isConsistHistoryApiFailed = false;
            let isHistorySkipped = false;          
            
            if (skipHistory) {
                isHistorySkipped = true;
                cachedConsistHistoryData = [];
                if (trainNo !== lastQueriedTrainNo || isFullQuery) {
                    lastQueriedTrainNo = trainNo; 
                    resetCalendar(trainNo);
                }
            }

            if (isFullQuery && !skipHistory) {
                statusElement.textContent = `æ­£åœ¨æŸ¥è¯¢ ${trainNo} çš„å†å²æ‹…å½“å’ŒåŸºæœ¬ä¿¡æ¯...`;
                statusElement.className = '';
                lastQueriedTrainNo = trainNo; 
                resetCalendar(trainNo); 
                
                // Fetch History
                try {
                    const response = await fetch(`${API_BASE_URL_TRAIN}${trainNo}`);
                    if (!response.ok) throw new Error();
                    const rawData = await response.json();
                    cachedConsistHistoryData = Array.isArray(rawData) ? rawData : [];
                    
                    // **å…³é”®æ­¥éª¤ï¼šä»æ–°çš„ API é¢„åŠ è½½ç¼–ç»„ä¿¡æ¯**
                    if (cachedConsistHistoryData.length > 0) {
                        await prefetchConsistsForHistory(cachedConsistHistoryData);
                    }

                } catch (error) {
                    console.error('History API Error:', error);
                    isConsistHistoryApiFailed = true;
                    cachedConsistHistoryData = [];
                }
                
            } else if (!isFullQuery && !skipHistory) { 
                statusElement.textContent = `æ­£åœ¨æŸ¥è¯¢ ${trainNo} (${startDate}) çš„åŸºæœ¬ä¿¡æ¯`;
                isConsistHistoryApiFailed = cachedConsistHistoryData.length === 0;
            }
            
            const basicInfoResult = await fetchBasicTrainInfo(trainNo, startDate);
            
            let suggestedDateResult = null;
            if (!basicInfoResult.success && !skipHistory) {
                statusElement.textContent = `âš ï¸ è½¦æ¬¡ ${trainNo} åœ¨ ${startDate} ä¸å¼€è¡Œã€‚æ­£åœ¨è‡ªåŠ¨æœç´¢æœ€è¿‘å¼€è¡Œæ—¥æœŸ...`;
                statusElement.className = 'error';
                suggestedDateResult = await searchForRunningDate(trainNo, startDate);
                
                if (suggestedDateResult) {
                    const newDate = suggestedDateResult.date;
                    const directionText = suggestedDateResult.direction === 'forward' ? 'å‘å' : 'å‘å‰';
                    const days = suggestedDateResult.days;
                    statusElement.textContent = `âœ… è‡ªåŠ¨æœç´¢æˆåŠŸï¼å·²è·³è½¬è‡³ï¼š${newDate} (ç›¸å¯¹ ${startDate} ${directionText} ${days} å¤©)ã€‚`;
                    statusElement.className = 'success'; 
                    await queryTrainData(trainNo, newDate, true); 
                    document.getElementById('top').scrollIntoView({ behavior: 'smooth' });
                    return; 
                } else {
                    statusElement.textContent = `âŒ ${startDate} ä¸å¼€è¡Œã€‚è‡ªåŠ¨æœç´¢æœªæ‰¾åˆ°ç›¸è¿‘æ—¥æœŸã€‚`;
                    statusElement.className = 'error';
                }
            } else if (!basicInfoResult.success && skipHistory) {
                 statusElement.textContent = `âš ï¸ æ™®é€Ÿ/å¸‚éƒŠè½¦æ¬¡ ${trainNo} åœ¨ ${startDate} ä¸å¼€è¡Œ: ${basicInfoResult.message}ã€‚`;
                 statusElement.className = 'error';
            }

            renderResults(cachedConsistHistoryData, trainNo, basicInfoResult, isConsistHistoryApiFailed, isHistorySkipped, startDate, suggestedDateResult);
            
            if (basicInfoResult.success) {
                 statusElement.textContent = `âœ… æŸ¥è¯¢æˆåŠŸã€‚`;
                 statusElement.className = 'success';
            }
            document.getElementById('top').scrollIntoView({ behavior: 'smooth' });
        }

        // ----------------------------------------------------
        // 7. æ¸²æŸ“é€»è¾‘ (UI)
        // ----------------------------------------------------

        function toggleStationTable() {
            const container = document.getElementById('fullStationTableContainer');
            const toggle = document.getElementById('stationInfoToggle');
            if (!container || !toggle) return; 
            if (container.style.display === 'none') {
                container.style.display = 'block';
                toggle.textContent = 'åœç«™ä¿¡æ¯ (ç‚¹å‡»éšè—)';
                toggle.style.color = '#dc3545'; 
            } else {
                container.style.display = 'none';
                toggle.textContent = 'åœç«™ä¿¡æ¯ (ç‚¹å‡»æ˜¾ç¤º)';
                toggle.style.color = '#1a73e8'; 
            }
        }

        function toggleTrainsetTypeInfo() {
            const container = document.getElementById('fullTrainsetTypeInfoContainer');
            const toggle = document.getElementById('trainsetTypeInfoToggle');
            if (!container || !toggle) return;
            if (container.style.display === 'none') {
                container.style.display = 'block';
                toggle.textContent = 'è½¦è¾†ä¿¡æ¯ (ç‚¹å‡»éšè—)';
                toggle.style.color = '#dc3545';
            } else {
                toggle.textContent = 'è½¦è¾†ä¿¡æ¯ (ç‚¹å‡»æ˜¾ç¤º)';
                toggle.style.color = '#1a73e8';
                container.style.display = 'none';
            }
        }

        function generateBasicInfoHtml(info, trainNo, userStartDate, suggestedDateResult) {
            const parts = userStartDate.split('-'); 
            const displayDateStr = parts.length === 3 ? `${parts[0]}å¹´${parts[1]}æœˆ${parts[2]}æ—¥` : userStartDate;

            if (!info || !info.success) {
                let errorHtml = `<div class="basic-info-box error-box"><p style="color: red; font-weight: bold;">âŒ è½¦æ¬¡ ${trainNo} åœ¨ ${displayDateStr} ä¸å¼€è¡Œ: ${info.message || 'æœªçŸ¥é”™è¯¯'}</p>`;
                if (suggestedDateResult) {
                    errorHtml += `<p style="color: #c0392b; margin-top: 10px;">ç³»ç»Ÿå·²è‡ªåŠ¨æœç´¢ï¼Œä½†<strong style="color: red;">æœªæ‰¾åˆ°å¼€è¡Œæ—¥æœŸ</strong>ã€‚</p>`;
                } else if (!shouldSkipEmuHistory(trainNo)) {
                     errorHtml += `<p style="color: #c0392b; margin-top: 10px;">è¯·åœ¨ä¸Šæ–¹æ—¥å†ä¸­æ‰‹åŠ¨é€‰æ‹©å…¶ä»–æ—¥æœŸ</p>`;
                }
                errorHtml += `</div>`;
                return errorHtml;
            }

            const trainInfo = info.info;
            const formattedStartTime = formatTime(trainInfo.startTime.substring(9) || trainInfo.startTime);
            const formattedArriveTime = formatTime(trainInfo.arriveTime.substring(9) || trainInfo.arriveTime);
            
            // å‹å·æ˜¾ç¤º
            const emuStylePrimary = trainInfo.emu_style_no_primary || ''; 
            const emuStyleFallback = trainInfo.emu_style_no_fallback || ''; 
            let emuStyleDisplay;
            if (emuStylePrimary && emuStyleFallback && emuStylePrimary !== emuStyleFallback) {
                emuStyleDisplay = `${emuStyleFallback} (${emuStylePrimary})`;
            } else {
                emuStyleDisplay = emuStylePrimary || emuStyleFallback || 'æ— ä¿¡æ¯';
            }

            const trainsetTypeInfo = trainInfo.trainsetTypeInfo;
            const newTitle = `${trainNo}æ¬¡ ï¼ˆ${trainInfo.start_station_name || 'æœªçŸ¥'}â†’${trainInfo.end_station_name || 'æœªçŸ¥'}ï¼‰ ${displayDateStr} åˆ—è½¦å¼€è¡Œä¿¡æ¯`;
            
            let infoHtml = `
                <div class="basic-info-box">
                    <h3 style="color: #333; border-bottom: 1px solid #ddd; padding-bottom: 5px; margin-bottom: 15px;">${newTitle}</h3>
                    <div style="display: flex; flex-wrap: wrap; gap: 10px 30px; font-size: 0.95em;">
                        <div style="min-width: 220px;"><strong>å§‹å‘ç«™/æ—¶é—´:</strong> <strong>${trainInfo.start_station_name}</strong> (${formattedStartTime})</div>
                        <div style="min-width: 220px;"><strong>ç»ˆåˆ°ç«™/æ—¶é—´:</strong> <strong>${trainInfo.end_station_name}</strong> (${formattedArriveTime})</div>
                        <div style="min-width: 220px;"><strong>æ‹…å½“å‹å·:</strong> <strong style="color:#e67e22;">${emuStyleDisplay}</strong></div>
                        <div style="min-width: 220px;"><strong>å®¢è¿æ‹…å½“:</strong> ${trainInfo.jiaolu_corporation_code || 'æ— ä¿¡æ¯'}</div>
                        <div style="min-width: 220px;"><strong>è½¦åº•æ‹…å½“:</strong> ${trainInfo.jiaolu_dept_train || 'æ— ä¿¡æ¯'}</div>
                    </div>`;

            // åœç«™ä¿¡æ¯
            infoHtml += `<h4 id="stationInfoToggle" onclick="toggleStationTable()" style="margin-top: 20px; color: #1a73e8; cursor: pointer; text-decoration: underline;">åœç«™ä¿¡æ¯ (ç‚¹å‡»æ˜¾ç¤º)</h4>
                <div id="fullStationTableContainer" style="display: none;">`; 
            
            const stations = trainInfo.stations || [];
            if (stations.length === 0) {
                infoHtml += `<p>æ— åœç«™ä¿¡æ¯ã€‚</p>`;
            } else {
                infoHtml += `<table class="basic-info-station-table"><thead><tr>
                        <th style="width: 5%;">ç«™åº</th><th style="width: 13%;">è½¦ç«™</th><th style="width: 10%;">åˆ°è¾¾æ—¶é—´</th><th style="width: 10%;">å‘è½¦æ—¶é—´</th>
                        <th style="width: 7%;">åœè½¦æ—¶é—´</th><th style="width: 7%;">å¤©æ•°</th><th style="width: 18%;">è½¦ç«™éš¶å±</th>
                        <th style="width: 10%;">å€™è½¦å®¤</th><th style="width: 10%;">è¿›ç«™å£</th><th style="width: 10%;">å‡ºç«™å£</th>
                    </tr></thead><tbody>`;
                
                stations.forEach((station, index) => { 
                    const isFirst = index === 0;
                    const isLast = index === stations.length - 1;
                    infoHtml += `<tr>
                        <td>${station.station_no || (station.start_time === '-' ? 'ç»ˆç‚¹' : '--')}</td>
                        <td>${station.station_name}</td>
                        <td>${isFirst ? '---' : formatTime(station.arrive_time.substring(9) || station.arrive_time)}</td>
                        <td>${isLast ? '---' : formatTime(station.start_time.substring(9) || station.start_time)}</td>
                        <td>${station.stop_time || '---'}</td>
                        <td>${formatDayDifference(station.dayDifference)}</td>
                        <td>${formatStationCorporationCode(station.station_name, station.station_corporation_code)}</td>
                        <td>${station.waitingRoom || '---'}</td>
                        <td>${station.wicket || '---'}</td>
                        <td>${station.exit || '---'}</td>
                    </tr>`;
                });
                infoHtml += `</tbody></table>`;
            }
            infoHtml += `</div>`; 
            
            // è½¦å‹ä¿¡æ¯
            if (trainsetTypeInfo && Object.keys(trainsetTypeInfo).length > 0) {
                const infoMap = [
                    ['è½¦å‹', trainsetTypeInfo.trainsetTypeName], ['è¾†æ•°', trainsetTypeInfo.coachCount],
                    ['æ€»é•¿', trainsetTypeInfo.fullLength], ['è½¦è¾†ç»„æˆ', trainsetTypeInfo.coachOrganization],
                    ['å®šå‘˜', trainsetTypeInfo.capacity], ['æœ€å¤§è¿è¥é€Ÿåº¦', trainsetTypeInfo.currentSpeed],
                    ['åˆ¶é€ å‚å•†', trainsetTypeInfo.manufacturer], ['é¤è½¦ä½ç½®', trainsetTypeInfo.mealCoach],
                ];
                infoHtml += `<h4 id="trainsetTypeInfoToggle" onclick="toggleTrainsetTypeInfo()" style="margin-top: 20px; color: #1a73e8; cursor: pointer; text-decoration: underline;">è½¦è¾†ä¿¡æ¯ (ç‚¹å‡»æ˜¾ç¤º)</h4>
                    <div id="fullTrainsetTypeInfoContainer" style="display: none;">
                        <table class="trainset-info-table"><tbody>`;
                for (let i = 0; i < infoMap.length; i += 2) {
                    infoHtml += `<tr><td>${infoMap[i][0]}</td><td>${infoMap[i][1] || 'æ— ä¿¡æ¯'}</td>`;
                    if (i + 1 < infoMap.length) infoHtml += `<td>${infoMap[i+1][0]}</td><td>${infoMap[i+1][1] || 'æ— ä¿¡æ¯'}</td></tr>`;
                    else infoHtml += `<td colspan="2"></td></tr>`;
                }
                infoHtml += `</tbody></table></div>`;
            }

            infoHtml += `</div>`; 
            return infoHtml;
        }

        // ----------------------------------------------------
        // 7. æ¸²æŸ“é€»è¾‘ (UI)
        // ----------------------------------------------------

        // æ³¨æ„ï¼šè¿™é‡Œéœ€è¦ä¾èµ–æ‚¨å·²ç»ä½¿ç”¨çš„ generateTechInfoHtml å’Œ generateCapacityInfoHtmlï¼Œ
        // å®ƒä»¬å¿…é¡»æ˜¯å·²ä¿®å¤çš„ç‰ˆæœ¬ï¼ˆå¤„ç†äº†æ•°å­—ç±»å‹çš„å­—æ®µï¼‰ã€‚
        
        function renderResults(data, trainNo, basicInfoResult, isConsistHistoryApiFailed, isHistorySkipped, userStartDate, suggestedDateResult) {
            data.sort((a, b) => new Date(b.date) - new Date(a.date));

            const groupedByDate = {};
            data.forEach(record => {
                const dateKey = record.date.substring(0, 10); 
                if (!groupedByDate[dateKey]) groupedByDate[dateKey] = [];
                groupedByDate[dateKey].push(record);
            });

            const consistDetailsContainer = document.getElementById('consistDetailsContainer');
            let finalHtml = '<h2>ğŸ“„ è¯¦ç»†ä¿¡æ¯</h2>';
            finalHtml += generateBasicInfoHtml(basicInfoResult, trainNo, userStartDate, suggestedDateResult);
            
            let consistDetailsHtml = '';
            
            if (basicInfoResult.success && data.length > 0) {
                finalHtml += '<h2 style="margin-top: 30px;">ğŸ“… åŠ¨è½¦ç»„æ‹…å½“å†å²</h2>';
                let index = 0; 

                Object.keys(groupedByDate).sort().reverse().forEach(dateKey => {
                    const records = groupedByDate[dateKey];
                    let isFaultChangeAlert = false; // æ•…éšœæ¢è½¦åº•è­¦å‘Šæ ‡è®°

                    // --- æ•…éšœæ¢è½¦åº•æ£€æµ‹é€»è¾‘ ---
                    if (records.length >= 3) {
                        isFaultChangeAlert = true;
                    } else if (records.length === 2) {
                        const emuNo1 = records[0].emu_no;
                        const emuNo2 = records[1].emu_no;

                        const consistData1 = CONSIST_DATA_MAP.get(emuNo1);
                        const consistData2 = CONSIST_DATA_MAP.get(emuNo2);

                        // ä» API æ•°æ®ä¸­è·å–ç¼–ç»„è¾†æ•°ï¼Œå¹¶ç¡®ä¿æ˜¯æ•°å­—
                        let count1 = consistData1 ? parseInt(consistData1.record['ç¼–ç»„ï¼ˆè¾†ï¼‰'], 10) : 0;
                        let count2 = consistData2 ? parseInt(consistData2.record['ç¼–ç»„ï¼ˆè¾†ï¼‰'], 10) : 0;
                        
                        // æ’é™¤ NaN çš„æƒ…å†µ
                        count1 = isNaN(count1) ? 0 : count1;
                        count2 = isNaN(count2) ? 0 : count2;

                        // æ£€æŸ¥æ˜¯å¦å­˜åœ¨ 16 æˆ– 17 è¾†ç¼–ç»„
                        if ((count1 === 16 || count1 === 17) || (count2 === 16 || count2 === 17)) {
                            isFaultChangeAlert = true;
                        }
                    }
                    // --------------------------


                    // --- 1. å•ç»„è¿è¡Œé€»è¾‘ ---
                    if (records.length === 1) {
                        const record = records[0];
                        const emuNo = record.emu_no || 'æœªçŸ¥åŠ¨è½¦ç»„';
                        const consistData = CONSIST_DATA_MAP.get(emuNo);
                        if (consistData) {
                            consistDetailsHtml += generateConsistBox(consistData, trainNo, emuNo, dateKey, index++);
                        } else {
                            consistDetailsHtml += generateErrorBox(trainNo, emuNo, dateKey, index++);
                        }
                    } 
                    
                    // --- 2. é‡è”è¿è¡Œ/å¤šç»„æ‹…å½“é€»è¾‘ ---
                    else if (records.length >= 2) {
                        const coupledIndex = index++;
                        consistDetailsHtml += `<div class="consist-detail-box coupled-box" id="consist-${coupledIndex}">
                                <p class="coupled-title">âš¡ï¸ é‡è”è¿è¡Œ (${records.length} ç»„) | è½¦æ¬¡ ${trainNo} | æ—¥æœŸ ${dateKey}</p>`;
                        
                        // æ’å…¥æ•…éšœæ¢è½¦åº•è­¦å‘Š
                        if (isFaultChangeAlert) { 
                             const alertMessage = records.length >= 3 
                                 ? `âš ï¸ å‘ç° ${records.length} ç»„æ‹…å½“è®°å½•ï¼Œ**æå¯èƒ½ä¸ºæ•…éšœæ¢è½¦åº•**ï¼` 
                                 : `âš ï¸ å‘ç° 2 ç»„é•¿ç¼–ç»„æ‹…å½“è®°å½•ï¼Œ**å¯èƒ½ä¸ºæ•…éšœæ¢è½¦åº•**ï¼`;
                             consistDetailsHtml += `<p style="color: #c0392b; font-weight: bold; padding: 5px; border: 1px dashed #c0392b; border-radius: 4px; margin-bottom: 10px;">${alertMessage}</p>`;
                        }

                        records.forEach((record, subIndex) => {
                            const emuNo = record.emu_no;
                            const consistData = CONSIST_DATA_MAP.get(emuNo);
                            const containerId = `consist-sub-${coupledIndex}-${subIndex}`;
                            
                            consistDetailsHtml += `<div class="single-consist" id="${containerId}">`; 
                            
                            if (consistData) {
                                const consistRecord = consistData.record;
                                
                                // ä¿®æ­£ç‚¹ 1: ä¼˜å…ˆæ˜¾ç¤ºAPIè¿”å›çš„è§„èŒƒåŒ–â€œè½¦ç»„å·â€
                                const displayEmuNo = consistRecord['è½¦ç»„å·'] || consistData.raw_key || emuNo;
                                
                                // ä¿®æ­£ç‚¹ 2 & 3: ç”ŸæˆæŠ€æœ¯å‚æ•°å’Œå®šå‘˜ä¿¡æ¯
                                const techInfoHtml = generateTechInfoHtml(consistRecord);
                                const capacityInfoHtml = generateCapacityInfoHtml(consistRecord);

                                consistDetailsHtml += `
                                    <p>åŠ¨è½¦ç»„ ${subIndex + 1}: 
                                        <strong class="emu-no-clickable" onclick="queryEmuHistory('${emuNo}', '${containerId}')">${displayEmuNo}</strong>
                                    </p>
                                    <p class="consist-info">é…å±ï¼š${generateConsistInfo(consistRecord)}</p>
                                    
                                    ${techInfoHtml}
                                    
                                    ${generateSingleTableContent(consistRecord)}
                                    
                                    ${capacityInfoHtml}

                                    <div id="emu-history-${containerId}" style="margin-top: 10px;"></div>`;
                            } else {
                                consistDetailsHtml += `<p style="color: red;">åŠ¨è½¦ç»„ ${subIndex + 1}: <strong>${emuNo}</strong> ç¼–ç»„æ•°æ®ç¼ºå¤± (æ•°æ®åº“ä¸­æœªæ‰¾åˆ°)</p>`;
                            }
                            consistDetailsHtml += `</div>`; // å…³é—­ single-consist
                        });
                        consistDetailsHtml += `<a href="#top" style="display: block; text-align: right; margin-top: 10px; color: #1a73e8;">â†‘ è¿”å›é¡¶éƒ¨</a></div>`; // å…³é—­ coupled-box
                    }
                });
            } else {
                if (isHistorySkipped) {
                     consistDetailsHtml += `<h2 style="margin-top: 30px;">â„¹ï¸ è·³è¿‡åŠ¨è½¦ç»„æ‹…å½“å†å²æŸ¥è¯¢</h2>
                         <div class="consist-detail-box" style="border-color: #2980b9; background-color: #ecf0f1;">
                             <p style="color: #2c3e50; text-align: center;">è½¦æ¬¡ ${trainNo} å±äºæ™®é€Ÿ/å¸‚éƒŠç±»å‹ï¼Œå·²è·³è¿‡æ‹…å½“æŸ¥è¯¢ã€‚</p>
                         </div>`;
                } else if (basicInfoResult.success || isConsistHistoryApiFailed) {
                    const messageText = isConsistHistoryApiFailed ? 'APIè¯·æ±‚å¤±è´¥ï¼Œæ— æ³•è·å–å†å²æ‹…å½“ä¿¡æ¯ã€‚' : `APIæœªè¿”å›è¿‘æœŸæ‹…å½“è®°å½•ã€‚`;
                    consistDetailsHtml += `<h2 style="margin-top: 30px;">âš ï¸ åŠ¨è½¦ç»„æ‹…å½“å†å²è®°å½•</h2>
                        <div class="consist-detail-box" style="border-color: #f39c12; background-color: #fef9e7;">
                            <p style="color: #e67e22;">${messageText}</p>
                        </div>`;
                }
            }
            consistDetailsContainer.innerHTML = finalHtml + consistDetailsHtml;
        }

        function generateConsistInfo(record) {
            const bureau = record['é…å±å±€'] || 'æœªçŸ¥';
            const subdivision = record['é…å±æ®µ'] || 'æœªçŸ¥';
            const depot = record['é…å±æ‰€'] || 'æœªçŸ¥';
            return `${bureau}${subdivision}${depot}`;
        }

        function generateSingleTableContent(consistRecord) {
            // API è¿”å›çš„ç¼–ç»„æ˜¯å­—ç¬¦ä¸²æˆ–æ•°å­—
            const emuCount = parseInt(consistRecord['ç¼–ç»„ï¼ˆè¾†ï¼‰'], 10);
            if (isNaN(emuCount) || emuCount <= 0 || emuCount > 20) return `<p style="color: red;">âš ï¸ ç¼–ç»„æ•°é‡ï¼ˆ${consistRecord['ç¼–ç»„ï¼ˆè¾†ï¼‰']}ï¼‰æ— æ•ˆã€‚</p>`;
            
            let carNoRow = '<tr><th>è½¦å·</th>';
            let carTypeRow = '<tr><th>è½¦ç§</th>';
            let capacityRow = '<tr><th>å®šå‘˜</th>';
            for (let i = 1; i <= emuCount; i++) {
                const isMaxCar = (i === emuCount);
                const carNumStr = isMaxCar ? '00' : (i < 10 ? `0${i}` : `${i}`); 
                const lookupKeyPrefix = i < 10 ? `0${i}` : `${i}`;
                // API keys: "01è½¦è½¦ç§", "01è½¦å®šå‘˜"
                const carType = consistRecord[`${lookupKeyPrefix}è½¦è½¦ç§`] || 'N/A';
                const capacity = consistRecord[`${lookupKeyPrefix}è½¦å®šå‘˜`] || 'N/A';
                const isDiningCar = carType.includes('C') && carType !== 'JC';
                const diningCarClass = isDiningCar ? ' class="car-type-c"' : '';
                
                carNoRow += `<td>${carNumStr}</td>`;
                carTypeRow += `<td${diningCarClass}>${carType}</td>`;
                capacityRow += `<td>${capacity}</td>`;
            }
            carNoRow += '</tr>';carTypeRow += '</tr>';capacityRow += '</tr>';
            return `<table class="consist-table">${carNoRow}${carTypeRow}${capacityRow}</table>`;
        }

        /**
         * ä¿®æ­£ç‰ˆï¼šç”ŸæˆæŠ€æœ¯å‚æ•° HTML
         * ä¿®å¤äº†æ•°å­—ç±»å‹è°ƒç”¨ .trim() æŠ¥é”™çš„é—®é¢˜
         */
        function generateTechInfoHtml(record) {
            const fields = [
                'åˆ¶é€ å‚', 'åˆ¶é€ æ—¥æœŸ', 'æœ€é«˜è¿è¥é€Ÿåº¦ï¼ˆkm/hï¼‰', 'ç¼–ç»„ï¼ˆè¾†ï¼‰','åˆ—è½¦æ€»é•¿ï¼ˆmï¼‰', 
                'è½®å‘¨ç‰µå¼•æ€»åŠŸç‡ï¼ˆkWï¼‰', 'ç¼–ç»„æ–¹å¼', 
                'ç‰¹æ®Šæ¶‚è£…', 'å¤‡æ³¨', 'åº§æ¤…ç±»å‹'
            ];
            
            let html = '<div class="info-grid">';
            let hasContent = false;

            fields.forEach(field => {
                let val = record[field];
                
                // æ ¸å¿ƒä¿®å¤ï¼šå…ˆè½¬ä¸ºå­—ç¬¦ä¸²ï¼Œå†è¿›è¡Œåˆ¤æ–­
                // å¦‚æœ val æ˜¯ null æˆ– undefinedï¼Œè§†ä¸ºç©ºå­—ç¬¦ä¸²
                const strVal = (val === null || val === undefined) ? '' : String(val);

                // æ£€æŸ¥ï¼šéç©ºã€ä¸ç­‰äº "/"ã€å»ç©ºæ ¼åä¸ä¸ºç©º
                if (strVal && strVal !== '/' && strVal.trim() !== '') {
                    html += `
                        <div class="info-item">
                            <span class="info-label">${field}</span>
                            <span class="info-value">${strVal}</span>
                        </div>`;
                    hasContent = true;
                }
            });
            html += '</div>';
            return hasContent ? html : '';
        }

        /**
         * ä¿®æ­£ç‰ˆï¼šç”Ÿæˆå®šå‘˜/å¸­ä½ HTML
         * ä¿®å¤äº†æ•°å­—ç±»å‹è°ƒç”¨ .trim() æŠ¥é”™çš„é—®é¢˜
         */
        function generateCapacityInfoHtml(record) {
            const fields = [
                'EMISå®šå‘˜', 'å¸­ä½æ€»æ•°', 'å®¢ç¥¨å®šå‘˜',
                'å•†åŠ¡åº§-åŒ…é—´å¼', 'å•†åŠ¡åº§-é±¼éª¨å¼', 'å•†åŠ¡åº§-æ ‡å‡†å‹', 
                'ç‰¹ç­‰åº§', 'ä¼˜é€‰ä¸€ç­‰åº§', 'ä¸€ç­‰åº§', 'äºŒç­‰åº§', 
                'é«˜çº§åŠ¨å§', 'åŠ¨å§', 'å¤šåŠŸèƒ½åº§', 'é¤åº§', 'æ— åº§', 
                'éå¯¹å·å®šå‘˜-é¤åº§', 'éå¯¹å·å®šå‘˜-è¾¹åº§', 'éå¯¹å·å®šå‘˜-å…¶ä»–', 'éå¯¹å·å®šå‘˜-æ— åº§'
            ];

            let html = '<div class="info-grid capacity-grid">';
            let hasContent = false;

            fields.forEach(field => {
                let val = record[field];
                
                // æ ¸å¿ƒä¿®å¤ï¼šå…ˆè½¬ä¸ºå­—ç¬¦ä¸²
                const strVal = (val === null || val === undefined) ? '' : String(val);

                if (strVal && strVal !== '/' && strVal.trim() !== '') {
                    html += `
                        <div class="info-item">
                            <span class="info-label">${field}</span>
                            <span class="info-value">${strVal}</span>
                        </div>`;
                    hasContent = true;
                }
            });
            html += '</div>';
            return hasContent ? html : '';
        }

        /**
         * ä¿®æ”¹åçš„ä¸»æ¸²æŸ“å‡½æ•°ï¼šgenerateConsistBox
         */
        function generateConsistBox(consistData, trainNo, apiEmuNo, displayDate, index) {
            const consistRecord = consistData.record;
            const containerId = `consist-${index}`;
            
            // ä¿®æ”¹ç‚¹ 1: ä¼˜å…ˆæ˜¾ç¤ºAPIè¿”å›çš„è§„èŒƒåŒ–â€œè½¦ç»„å·â€ (ä¾‹å¦‚ CR400AF-2224)ï¼Œå¦‚æœä¸å­˜åœ¨åˆ™å›é€€åˆ°åŸå§‹ key
            const displayEmuNo = consistRecord['è½¦ç»„å·'] || consistData.raw_key || apiEmuNo;

            // ç”Ÿæˆå„éƒ¨åˆ† HTML
            const techInfoHtml = generateTechInfoHtml(consistRecord);
            const tableHtml = generateSingleTableContent(consistRecord);
            const capacityInfoHtml = generateCapacityInfoHtml(consistRecord);

            return `
                <div class="consist-detail-box" id="${containerId}">
                    <h4>
                        è½¦æ¬¡ ${trainNo} | æ—¥æœŸ ${displayDate} | 
                        åŠ¨è½¦ç»„ <strong class="emu-no-clickable" onclick="queryEmuHistory('${apiEmuNo}', '${containerId}')">${displayEmuNo}</strong>
                    </h4>
                    
                    <p class="consist-info">é…å±ï¼š${generateConsistInfo(consistRecord)}</p>
                    
                    ${techInfoHtml}
                    
                    ${tableHtml}
                    
                    ${capacityInfoHtml}

                    <div id="emu-history-${containerId}" style="margin-top: 10px;"></div> 
                    <a href="#top" style="display: block; text-align: right; margin-top: 10px; color: #1a73e8;">â†‘ è¿”å›é¡¶éƒ¨</a>
                </div>`;
        }

        function generateErrorBox(trainNo, apiEmuNo, displayDate, index) {
            return `<div class="consist-detail-box" id="consist-${index}" style="border-color: #e74c3c; background-color: #fbecec;">
                    <h4>è½¦æ¬¡ ${trainNo} | æ—¥æœŸ ${displayDate} | åŠ¨è½¦ç»„ ${apiEmuNo}</h4>
                    <p style="color: red;">âŒ ç¼–ç»„æ•°æ®ç¼ºå¤±ï¼æ•°æ®åº“ä¸­æœªæ‰¾åˆ°è½¦ç»„å· **${apiEmuNo}** çš„è®°å½•ã€‚</p>
                    <a href="#top" style="display: block; text-align: right; margin-top: 10px; color: #1a73e8;">â†‘ è¿”å›é¡¶éƒ¨</a>
                </div>`;
        }

        async function queryEmuHistory(emuNoKey, containerId) {
            const resultDiv = document.getElementById(`emu-history-${containerId}`);
            if (!resultDiv) return;
            if (resultDiv.innerHTML !== '') { resultDiv.innerHTML = ''; return; }

            resultDiv.innerHTML = `<p style="text-align: center; color: #555;">æ­£åœ¨æŸ¥è¯¢ ${emuNoKey} è¿‘æœŸæ‹…å½“æƒ…å†µ...</p>`;

            // è¿™é‡Œä½¿ç”¨ rawKey å› ä¸ºå†å² API åº”è¯¥èƒ½è¯†åˆ«ï¼ˆå‡è®¾æ ¼å¼ä¸€è‡´ï¼‰
            // å¦‚æœå†å² API éœ€è¦ç‰¹æ®Šå¤„ç†ï¼Œå¯ä»¥åœ¨æ­¤æ·»åŠ  cleanEmuKey
            const apiUrl = `${API_BASE_URL_HISTORY}${emuNoKey}`;

            try {
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`Status ${response.status}`);
                const historyData = await response.json();

                let content = `<span class="close-history-btn" onclick="document.getElementById('emu-history-${containerId}').innerHTML=''">X</span>`;
                
                if (historyData.length === 0) {
                    content += `<p style="color: #6c757d; text-align: center;">æ— è¿‘æœŸæ‹…å½“è®°å½•ã€‚</p>`;
                } else {
                    const groupedByDate = {};
                    historyData.forEach(record => {
                        const dateKey = record.date ? record.date.substring(0, 10) : 'æœªçŸ¥';
                        if (!groupedByDate[dateKey]) groupedByDate[dateKey] = [];
                        groupedByDate[dateKey].push(record);
                    });

                    const finalDisplayList = [];
                    const recordsPromises = [];

                    // é¢„å¤„ç†æ‰€æœ‰è®°å½•ä»¥è·å–èµ·è®«ç«™
                    const sortedDates = Object.keys(groupedByDate).sort().reverse();
                    
                    for (const dateKey of sortedDates) {
                        const records = groupedByDate[dateKey].sort((a, b) => new Date(a.date) - new Date(b.date));
                        const endpointsPromises = records.map(r => fetchTrainEndpoints(r.train_no, r.date));
                        
                        recordsPromises.push(Promise.all(endpointsPromises).then(endpointsResults => {
                            let trainsHtml = '';
                            if (endpointsResults.length > 0) {
                                let lastEnd = endpointsResults[0].start.trim();
                                trainsHtml += lastEnd;
                                records.forEach((r, idx) => {
                                    const ep = endpointsResults[idx];
                                    const link = `<span class="history-train-link" onclick="queryTrainData('${r.train_no}', TODAY_DATE_STR, true)">${r.train_no}</span>`;
                                    if (lastEnd !== ep.start.trim()) trainsHtml += ` <span class="missing-link">(~ç¼ºå¤±~)</span> ${ep.start.trim()}`;
                                    trainsHtml += ` ~ ${link} ~ ${ep.end.trim()}`;
                                    if (ep.start.trim() === ep.end.trim() && idx < records.length - 1) trainsHtml += ` <span class="missing-link">(~ç¼ºå¤±~)</span> `;
                                    lastEnd = ep.end.trim();
                                });
                            } else { trainsHtml = 'æ— æ³•è·å–èµ·è®«ç«™'; }
                            return { date: dateKey, html: trainsHtml };
                        }));
                    }
                    
                    const listItems = await Promise.all(recordsPromises);
                    content += `<table class="history-table"><thead><tr><th style="width: 20%;">æ—¥æœŸ</th><th>äº¤è·¯</th></tr></thead><tbody>`;
                    listItems.forEach(item => { content += `<tr><td>${item.date}</td><td>${item.html}</td></tr>`; });
                    content += `</tbody></table>`;
                }
                resultDiv.innerHTML = content;
            } catch (error) {
                resultDiv.innerHTML = `<span class="close-history-btn" onclick="document.getElementById('emu-history-${containerId}').innerHTML=''\">X</span><p style="color: red; text-align: center;">æŸ¥è¯¢å¤±è´¥: ${error.message}</p>`;
            }
        }

        window.onload = () => {
            const today = new Date();
            TODAY_DATE_STR = formatDateToYYYYMMDD(today);
            // é¡µé¢åŠ è½½æ˜¾ç¤ºç™»å½•æ¡†
            document.getElementById('loginModal').style.display = 'flex';
        };
    </script>
</body>
</html>